---
title: "2025 WNBA Standings"
format: 
  html:
    fig-width: 10
    fig-height: 6
    toc: false
lightbox: true
---

```{r}
#| include: false
source('code/setupStandings.R')
source('code/setupElo.R')
```


```{r}
#| echo: false
#| message: false
year <- 2025
inseason <- FALSE
if(inseason){
    sched <- getSchedule(year)
}else{
    sched <- readRDS(paste0('data/sched',year,'.rds'))
}
```

::: {.panel-tabset}
## Static

```{r}
#| echo: false
#| message: false
#| classes: light-mode
makeWNBAstandingsGraph(year, sched)
```

```{r}
#| echo: false
#| message: false
#| classes: dark-mode
makeWNBAstandingsGraph(year, sched, mode = 'dark')
```



```{r}
#| echo: false
#| message: false
# update allgames to include partial season
if(inseason){
    allgames <- addSched2Allgames(year, sched, allgames)
}
# rm(sched)
```


```{r}
#| echo: false
#| message: false
#| classes: light-mode
makeWNBAeloGraph(year, allgames)
```

```{r}
#| echo: false
#| message: false
#| classes: dark-mode
makeWNBAeloGraph(year, allgames, mode = 'dark')
```

## Interactive
```{r}
#| echo: false
#| message: false
#| classes: light-mode
interactiveWNBAstandingsGraph(year, sched, mode = 'light')
```

```{r}
#| echo: false
#| message: false
#| classes: dark-mode
interactiveWNBAstandingsGraph(year, sched, mode = 'dark')
```


```{r}
#| echo: false
#| message: false
#| classes: light-mode
interactiveWNBAeloGraph(year, allgames, mode = 'light')
```

```{r}
#| echo: false
#| message: false
#| classes: dark-mode
interactiveWNBAeloGraph(year, allgames, mode = 'dark')
```

:::

### About these plots

Standings plots show how many games above or below .500 each team was throughout the course of the season. Ties are broken arbitrarily, as I didn't actually code up the tie-breaker scenarios.

Elo ratings are a way of estimating a team's "true" skill level, invented by Arpad Elo to rank chess players ([Wikipedia](https://en.wikipedia.org/wiki/Elo_rating_system)). The rating system used here was adapted from the WNBA ratings system implemented by fivethirtyeight.com. Ratings are partially carried over from year to year, which is why the lines have different starting values. The long-run average rating is 1500.



# Upcoming Games

```{r}
#| echo: false
#| message: false
# get upcoming games
season <- allgames[which(allgames$season == year), ]

upcoming <- season[which(is.na(allgames$PTShome)), ]
if(nrow(upcoming) > 6){
    upcoming <- upcoming[1:6, ]
}

getRecord <- function(team, season){
    away <- season[which(season$`Visitor/Neutral` == team), ]
    awayWL <- away$PTSvis > away$PTShome
    awayWL <- awayWL[!is.na(awayWL)]
    home <- season[which(season$`Home/Neutral` == team), ]
    homeWL <- home$PTShome > home$PTSvis
    homeWL <- homeWL[!is.na(homeWL)]
    record <- c(sum(c(awayWL,homeWL)), sum(c(!awayWL,!homeWL)))
    return(record)
}

plotGame <- function(game, rA, rH){
    par(mar=c(.1,.1,.1,.1))
    plot(0:1,0:1,col='transparent', axes=FALSE)
    rect(0,1/3,1,2/3, col=alpha(par("fg"),alpha=.1), border = NA)
    rect(0,0,1,2/3, col='transparent')
    # date, team names
    text(0,5/6, labels = format(game$Date, "%a, %b %d"), pos = 4)
    text(0,.5, labels = paste0(game$`Visitor/Neutral`,' (',rA[1],'-',rA[2],')'), pos = 4, font = 2)
    text(0,1/6, labels = paste0(game$`Home/Neutral`,' (',rH[1],'-',rH[2],')'), pos = 4, font = 2)
    
    if(!is.na(game$PTSvis)){ # game has already happened
        # Score
        text(1,5/6, labels = "Score", pos = 2)
        text(1,.5, labels = game$PTSvis, pos = 2)
        text(1,1/6, labels = game$PTShome, pos = 2)
        # pre-game winProbs / correct pick
        probCol <- 2
        if(game$homeWinProb > .5 & game$PTShome > game$PTSvis){
            probCol <- 3
        }
        if(game$homeWinProb < .5 & game$PTShome < game$PTSvis){
            probCol <- 3
        }
        text(.9,.5, labels = paste0(format(100*(1-game$homeWinProb), digits = 3, nsmall = 1),'%'), pos = 2, cex = .67, col = probCol)
            text(.9,1/6, labels = paste0(format(100*(game$homeWinProb), digits = 3, nsmall = 1),'%'), pos = 2, cex = .67, col = probCol)
    }else{ # game is upcoming
        # WinProb
        text(1,5/6, labels = "WinProb", pos = 2)
        if(!is.na(game$homeWinProb)){
            text(1,.5, labels = paste0(format(100*(1-game$homeWinProb), digits = 3, nsmall = 1),'%'), pos = 2)
            text(1,1/6, labels = paste0(format(100*(game$homeWinProb), digits = 3, nsmall = 1),'%'), pos = 2)
        }
    }
}

```

```{r}
#| echo: false
#| message: false
#| fig-height: 1.5
#| fig-width: 8
#| classes: light-mode
layout(matrix(1:2, nrow=1))

par(mar = c(5,5,4,0)+.1, cex.lab = 1.25, cex.main = 2, bg = '#fffaf6')
for(i in seq_len(nrow(upcoming))){
    game <- upcoming[i,]
    plotGame(game, getRecord(game$`Visitor/Neutral`, season), getRecord(game$`Home/Neutral`, season))
}
if(nrow(upcoming) == 0){
    par(mar=c(.1,.1,.1,.1))
    plot(0:1,0:1,col='transparent', axes=FALSE)
    text(.5,.5, 'None')
}
```

```{r}
#| echo: false
#| message: false
#| fig-height: 1.5
#| fig-width: 8
#| classes: dark-mode
layout(matrix(1:2, nrow=1))

par(mar = c(5,5,4,0)+.1, cex.lab = 1.25, cex.main = 2, bg = '#fffaf6')
par(fg = 'white', bg = '#272935', col.axis = 'white', col.lab = 'white', col.main = 'white', col.sub = 'white')

for(i in seq_len(nrow(upcoming))){
    game <- upcoming[i,]
    plotGame(game, getRecord(game$`Visitor/Neutral`, season), getRecord(game$`Home/Neutral`, season))
}
if(nrow(upcoming) == 0){
    par(mar=c(.1,.1,.1,.1))
    plot(0:1,0:1,col='transparent', axes=FALSE)
    text(.5,.5, 'None')
}
```


# Recent Games


```{r}
#| echo: false
#| message: false
# get recent games
recent <- allgames[which(allgames$season == year & !is.na(allgames$PTShome)), ]
if(nrow(recent) > 6){
    recent <- recent[(nrow(recent)-5):nrow(recent), ]
}
```

```{r}
#| echo: false
#| message: false
#| fig-height: 1.5
#| fig-width: 8
#| classes: light-mode
layout(matrix(1:2, nrow=1))

par(mar = c(5,5,4,0)+.1, cex.lab = 1.25, cex.main = 2, bg = '#fffaf6')
for(i in rev(seq_len(nrow(recent)))){
    game <- recent[i,]
    plotGame(game, getRecord(game$`Visitor/Neutral`, season), getRecord(game$`Home/Neutral`, season))
}
if(nrow(recent) == 0){
    par(mar=c(.1,.1,.1,.1))
    plot(0:1,0:1,col='transparent', axes=FALSE)
    text(.5,.5, 'None')
}
```

```{r}
#| echo: false
#| message: false
#| fig-height: 1.5
#| fig-width: 8
#| classes: dark-mode
layout(matrix(1:2, nrow=1))

par(mar = c(5,5,4,0)+.1, cex.lab = 1.25, cex.main = 2, bg = '#fffaf6')
par(fg = 'white', bg = '#272935', col.axis = 'white', col.lab = 'white', col.main = 'white', col.sub = 'white')

for(i in rev(seq_len(nrow(recent)))){
    game <- recent[i,]
    plotGame(game, getRecord(game$`Visitor/Neutral`, season), getRecord(game$`Home/Neutral`, season))
}
if(nrow(recent) == 0){
    par(mar=c(.1,.1,.1,.1))
    plot(0:1,0:1,col='transparent', axes=FALSE)
    text(.5,.5, 'None')
}
```


# Elo Model Performance

For each game, the model estimates the probabilities of each team winning, based on their relative ratings. These probabilities add up to 100% and we say that the model "picks" whichever team has better than a 50% chance of winning.

```{r}
#| echo: false
#| message: false
games <- allgames[which(allgames$season == year), ]

fwp <- pmax(games$homeWinProb, 1-games$homeWinProb)
homeTeamFavored <- games$homeWinProb > .5
homeTeamWon <- games$PTShome > games$PTSvis
favWon <- homeTeamFavored == homeTeamWon
winningTeamProb <- 100*ifelse(homeTeamWon, games$homeWinProb, 1-games$homeWinProb)
pc <- 100*mean(favWon, na.rm = TRUE)
# find biggest upset
winProb <- ifelse(games$PTShome > games$PTSvis,
                  games$homeWinProb, 1-games$homeWinProb)
upsetIdx <- which.min(winProb)
upset <- games[upsetIdx, ]
```

Percent correct: **`{r} format(pc, digits = 4)`%**

Record: **`{r} sum(favWon, na.rm=TRUE)`-`{r} sum(!favWon, na.rm=TRUE)`**

Biggest upset:

```{r}
#| echo: false
#| message: false
#| fig-height: 1.5
#| fig-width: 8
#| classes: light-mode
layout(matrix(1:2, nrow=1))

par(mar = c(5,5,4,0)+.1, cex.lab = 1.25, cex.main = 2, bg = '#fffaf6')
plotGame(upset, getRecord(upset$`Visitor/Neutral`, season), getRecord(upset$`Home/Neutral`, season))
```

```{r}
#| echo: false
#| message: false
#| fig-height: 1.5
#| fig-width: 8
#| classes: dark-mode
layout(matrix(1:2, nrow=1))

par(mar = c(5,5,4,0)+.1, cex.lab = 1.25, cex.main = 2, bg = '#fffaf6')
par(fg = 'white', bg = '#272935', col.axis = 'white', col.lab = 'white', col.main = 'white', col.sub = 'white')

plotGame(upset, getRecord(upset$`Visitor/Neutral`, season), getRecord(upset$`Home/Neutral`, season))
```
